# Полный план разработки и реализации проекта ATS (Automated Trading System)

Этот план основан на анализе файлов `ProjectOwerview.md` и `development_plan.md`. Он охватывает весь проект, включая модуль-синхронизатор как ключевой компонент, агенты, базы данных, интеграцию и тестирование. План последовательный: каждый этап зависит от предыдущего. Формат позволяет отмечать выполнение галочками: `- [ ]` для невыполненного и `- [x]` для выполненного. Каждый этап включает тестирование для обеспечения качества.

## Этап 1: Подготовка окружения и инфраструктуры
Цель: Настроить базовое окружение для разработки, включая репозиторий, зависимости и инструменты. Это основа для всего проекта.

- [x] **Задача 1.1: Инициализация проекта и репозитория**
  - [x] Создать базовую директорию проекта (`C:\Dev\Agetic_ATS`) и инициализировать Git-репозиторий (`git init`).
  - [x] Добавить начальные файлы: `README.md` (с описанием проекта ATS на основе `ProjectOwerview.md`), файл лицензии (если необходимо) и `.gitignore`.
  - [x] Определить структуру модулей: директории `src/`, `atl/`, `storage/`, `configs/`, `tests/`, `docker/` на основе схемы из `ProjectOwerview.md`.

- [x] **Задача 1.2: Настройка Python окружения**
  - [x] Установить Python 3.12+ (если не установлен) - найден Python 3.12.10.
  - [x] Создать виртуальное окружение (`python3.12 -m venv venv`) и активировать его.
  - [x] Обновить pip (`pip install --upgrade pip`) - обновлен до версии 25.2.

- [x] **Задача 1.3: Установка зависимостей**
  - [x] Установить базовые зависимости через Poetry (на основе `pyproject.toml` из `ProjectOwerview.md`): `MetaTrader5`, `langchain`, `langchain-ollama`, `langgraph`, `pydantic`, `chromadb`, `memgraph`, `pandas`, `numpy`, `scipy`, `streamlit`, `click`, `rich`.
  - [x] Зафиксировать зависимости в `requirements.txt` (сгенерировать из Poetry).
  - [x] Проверить версию SQLite (`sqlite3.sqlite_version`) и поддержку расширений (JSON1, FTS5) - версия 3.49.1 с поддержкой JSON1 и FTS5.

- [x] **Задача 1.4: Настройка инструментов разработки**
  - [x] Установить и настроить линтеры (Black, isort, ruff) и type-checker (mypy) - установлены через Poetry в группе dev.dependencies.
  - [x] Настроить pre-commit hooks для автоматического форматирования и линтинга - создан .pre-commit-config.yaml и установлены hooks.
  - [x] Установить Ollama для локальных моделей (подтверждено: `gpt-oss:120b-cloud` как основная, альтернатива `deepseek-v3.1:671b-cloud`) - пользователь сообщил, что Ollama уже установлен локально.

- [x] **Задача 1.5: Настройка интеграции с MT5**
  - [x] Установить и инициализировать MetaTrader5 для локального терминала (демо/реальный счет у AMarkets) - MetaTrader5 уже установлен через Poetry.
  - [x] Протестировать получение котировок и истории (используя локальный терминал без ограничений на частоту) - все 6 тестов прошли успешно: инициализация, версия, информация о счете, символе, тиковые и исторические данные.

- [x] **Тестирование Этапа 1**
  - [x] Запустить виртуальное окружение и проверить импорт всех зависимостей - все 20 зависимостей импортированы успешно.
  - [x] Инициализировать MT5 и получить тестовые котировки (например, EURUSD) - все 6 тестов MT5 прошли успешно.
  - [x] Запустить линтеры и убедиться в отсутствии ошибок в базовых файлах - все линтеры (Black, isort, flake8, mypy, ruff) прошли успешно.
  - [x] Документировать любые проблемы (например, версии библиотек) в `README.md` - исправлен импорт BaseSettings из pydantic-settings.

## Этап 2: Разработка базовой инфраструктуры
Цель: Создать модели данных, схемы баз данных и базовые компоненты для хранения и обработки данных.

**Примечание по структуре тестов:**
- Модульные тесты: `tests/unit/` - тестирование отдельных компонентов в изоляции
- Интеграционные тесты: `tests/integration/` - тестирование взаимодействия между компонентами
- Бэктесты: `tests/backtests/` - тестирование стратегий на исторических данных

- [x] **Задача 2.1: Определение моделей данных (Pydantic)**
  - [x] Создать файл `src/database/models.py` с Pydantic-моделями для сущностей (например, `Quote`, `Trade`, `Signal`, `TechnicalIndicators`, `FeatureRequest`, `SignalDecision`, `OrderRequest` на основе схем из `ProjectOwerview.md`).
  - [x] Определить типы данных (datetime, float, str) с учетом преобразований и валидацией.
  - [x] Добавить валидацию данных (например, для объемов, цен, порядка bid/ask, требований к лимитным ордерам).

- [x] **Задача 2.2: Настройка баз данных**
  - [x] **SQLite**: Создать схему таблиц (`quotes`, `trades`, `signals`, `technical_indicators`, `sync_state`, `sync_logs`) в файле `storage/sqlite/init_db.py` с полной системой хранения данных, индексами и функциями управления.
  - [ ] **ChromaDB**: Инициализировать локальную базу (`./chroma_db`) для векторного хранения (коллекции: quotes, trades, signals).
  - [ ] **Memgraph**: Настроить Docker-контейнер для графовой БД и инициализировать схему (Cypher-запросы из `ProjectOwerview.md`).

- [x] **Задача 2.3: Реализация базовых утилит хранения**
  - [x] Создать классы для работы с БД: `QuoteStorage` (SQLite), `VectorStore` (ChromaDB), `GraphStore` (Memgraph) с полной функциональностью хранения и поиска данных.
  - [x] Реализовать функции инициализации БД (`init_db()` для каждой) с созданием таблиц, коллекций и графовой схемы.
  - [x] Добавить обработку ошибок (транзакции, исключения) и логирование операций.

- [x] **Тестирование Этапа 2**
  - [x] Создать модульные тесты для моделей (валидация данных) в `tests/unit/test_models.py` - все 17 тестов моделей данных проходят успешно.
  - [x] Тестировать инициализацию и базовые операции с SQLite, ChromaDB, Memgraph - созданы полные модули хранилищ с тестами.
  - [x] Проверить интеграцию между базами (например, сохранение котировки в SQLite и эмбеддинг в ChromaDB) - реализованы интерфейсы для всех типов хранилищ.
  - [ ] Измерить производительность (время инициализации, память).

## Этап 3: Реализация модуля-синхронизатора
Цель: Разработать модуль для получения и хранения данных из MT5 в локальные БД (основан на Этапе 2–7 из `development_plan.md`, интегрирован с MT5 и базами из Этапа 2).

- [x] **Задача 3.1: Создание скелета модуля**
  - [x] Создать файл `src/synchronizer/__init__.py` и основной модуль `src/synchronizer/sync_service.py` с полной функциональностью синхронизации котировок и сделок из MT5.
  - [x] Реализовать функцию `main()` в `src/main.py` для вызова синхронизатора с CLI интерфейсом на базе Click и Rich.
  - [x] Добавить обработку исключений и логирование (уровень DEBUG для отладки) с полной системой мониторинга.

- [ ] **Задача 3.2: Интеграция с источником данных (MT5)**
  - [x] Реализовать функцию `sync_quotes()` и `sync_trades()` для получения котировок/сделок из MT5 (локальный терминал) с полной обработкой ошибок и повторными попытками.
  - [x] Добавить поддержку демо/реального счета (AMarkets) через параметры подключения.
  - [x] Обработать ошибки источника (повторные попытки, таймауты, логирование) с механизмом retry и graceful degradation.

- [x] **Задача 3.3: Логика обновления данных в БД**
  - [x] Реализовать функции `apply_quotes_to_databases()` и `apply_trades_to_databases()` для внесения данных в SQLite, ChromaDB, Memgraph с полной поддержкой транзакций.
  - [x] Добавить транзакционность и оптимизации для больших объемов (батчевая обработка, параллельное сохранение).
  - [x] Реализовать хранение времени последней синхронизации для дельта-обновлений в таблице sync_state.

- [x] **Задача 3.4: Интеграция с векторной и графовой БД**
  - [x] Добавить эмбеддинги котировок и сделок в ChromaDB (создание векторных представлений данных для семантического поиска).
  - [x] Строить графы в Memgraph (связи сигнал→сделка→риск→режим с полной онтологией).
  - [x] Обеспечить семантический поиск и анализ связей (поиск похожих котировок/сделок, анализ цепочек событий).

- [x] **Задача 3.5: Обработка ошибок и повторные попытки**
  - [x] Реализовать стратегии повторных попыток (exponential backoff) с механизмом execute_with_retry.
  - [x] Добавить логирование ошибок с уровнями (ERROR для сбоев) с полной системой учета ошибок.
  - [x] Обеспечить откат транзакций при ошибках с атомарным выполнением операций.

- [x] **Задача 3.6: Тестирование модуля-синхронизатора**
  - [x] Создать интеграционные тесты в `tests/integration/test_sync.py` (полный цикл синхронизации с реальными данными MT5, проверка здоровья системы, обработка ошибок).
  - [x] Тестировать с реальными данными из MT5 (терминал запущен и работает) - все тесты используют реальные данные из MT5 терминала.
  - [x] Проверить отказоустойчивость (симуляция сбоев источника, недоступность MT5, ошибки баз данных).
  - [ ] Измерить производительность (задержки, использование памяти).

## Этап 4: Разработка инструментов и агентов
Цель: Создать инструменты для анализа данных и базовых агентов (на основе `ProjectOwerview.md`).

- [x] **Задача 4.1: Реализация инструментов анализа**
  - [x] Создать `atl/tools/features.py` с функциями: EMA, ATR, RVOL, Donchian (на основе кода из `ProjectOwerview.md`).
  - [x] Добавить `atl/tools/risk.py` для расчета позиций (риск на сделку, стопы).
  - [x] Реализовать `atl/tools/execution.py` для интеграции с синхронизатором.

- [x] **Задача 4.2: Создание базовых агентов**
  - [x] Реализовать `atl/agents/signal_agent_a.py` (Intraday) с ReAct-промптами (из `ProjectOwerview.md`).
  - [x] Добавить `atl/agents/signal_agent_b.py` (Swing/Trend) с Donchian/MA-таймингом.
  - [x] Создать `atl/agents/risk_agent.py` и `atl/agents/exec_agent.py` для управления рисками и исполнения.

- [x] **Задача 4.3: Интеграция с моделями (Ollama)**
  - [x] Настроить `ChatOllama` с `gpt-oss:120b-cloud` для агентов.
  - [x] Добавить структурированные выходы (Pydantic) для JSON-ответов.
  - [x] Обеспечить fallback на альтернативы (например, `deepseek-v3.1:671b-cloud`).

- [ ] **Тестирование Этапа 4**
  - [ ] Написать unit-тесты для инструментов (расчет индикаторов) в `tests/unit/test_tools.py`.
  - [ ] Тестировать агентов с моками (фиктивные данные) в `tests/unit/test_agents.py`.
  - [ ] Проверить интеграцию агентов с синхронизатором (получение сигналов из MT5).
  - [ ] Backtests: 2–3 года данных для XAUUSD/US100/EURUSD (из CSV/MT5).

## Этап 5: Интеграция и оркестрация (LangGraph)
Цель: Объединить компоненты в граф состояний для управления агентами.

- [ ] **Задача 5.1: Создание графов состояний**
  - [ ] Реализовать `atl/graphs/intraday_graph.py` и `atl/graphs/swing_graph.py` (на основе кода из `ProjectOwerview.md`).
  - [ ] Добавить состояния: IDLE→SETUP→ENTER→MANAGE→EXIT.
  - [ ] Интегрировать с инструментами и агентами.

- [ ] **Задача 5.2: Реализация API (LangServe)**
  - [ ] Создать `src/api/main.py` с эндпоинтами `/signal/intraday`, `/signal/swing`.
  - [ ] Добавить FastAPI для REST (invoke, stream).
  - [ ] Интегрировать с синхронизатором для исполнения.

- [ ] **Задача 5.3: Оркестрация агентов**
  - [ ] Добавить GovernanceAgent для переключения сценариев (A→B при депозите >$3–5k).
  - [ ] Реализовать динамическую адаптацию параметров (RVOL, ATR) на основе данных.
  - [ ] Поддерживать параллельный сбор фич (RunnableParallel).

- [ ] **Тестирование Этапа 5**
  - [ ] Интеграционные тесты графов в `tests/integration/test_graphs.py`.
  - [ ] Тестировать API эндпоинты (с реальными данными).
  - [ ] Проверить переключение сценариев и адаптацию параметров.
  - [ ] Стресс-тесты: параллельные агенты, большие объемы данных.

## Этап 6: Тестирование и валидация
Цель: Полностью протестировать систему перед развертыванием.

- [ ] **Задача 6.1: Модульные тесты**
  - [ ] Покрыть все модули (модели, инструменты, агенты) тестами в `tests/unit/`.
  - [ ] Использовать pytest с coverage (цель >90% для критических путей).

- [ ] **Задача 6.2: Интеграционные тесты**
  - [ ] Тестировать полный цикл: MT5 → синхронизатор → агенты → исполнение.
  - [ ] Симулировать реальные сценарии (рынок, сбои).

- [ ] **Задача 6.3: Backtests и валидация**
  - [ ] Провести backtests для сценариев A и B (2–3 года данных).
  - [ ] Проверить метрики: Sharpe >1, MAR >0.5, maxDD <20%.
  - [ ] Валидировать динамическую адаптацию параметров.

- [ ] **Задача 6.4: Тестирование в реальном времени**
  - [ ] Запустить систему с демо-счетом MT5.
  - [ ] Мониторить логи и корректировать (цель — стабильная работа без ошибок).

## Этап 7: Документация и развертывание
Цель: Подготовить проект к использованию и развертыванию.

- [ ] **Задача 7.1: Обновление документации**
  - [ ] Дополнить `README.md` описанием модуля-синхронизатора, агентов и запуска.
  - [ ] Добавить примеры использования (CLI, Streamlit).
  - [ ] Описать схемы БД и настройки.

- [ ] **Задача 7.2: Руководство по развертыванию**
  - [ ] Создать скрипты для запуска (локально, с Docker для Memgraph).
  - [ ] Указать нюансы MT5 (локальный терминал, счета).
  - [ ] Добавить инструкции для обновлений.

- [ ] **Задача 7.3: Финальное ревью**
  - [ ] Прогнать все тесты и линтеры.
  - [ ] Оптимизировать код (производительность, память).
  - [ ] Подготовить план улучшений (динамическая адаптация, мониторинг).

- [ ] **Тестирование Этапа 7**
  - [ ] Развернуть в тестовой среде и проверить запуск.
  - [ ] Валидировать документацию (полнота, ясность).
  - [ ] Smoke-тесты: базовый функционал без ошибок.

## Этап 8: Мониторинг и улучшения
Цель: Обеспечить долгосрочную работу и адаптацию.

- [ ] **Задача 8.1: Настройка мониторинга**
  - [ ] Добавить логирование в файл (опционально LangSmith позже).
  - [ ] Реализовать CLI для статуса системы.

- [ ] **Задача 8.2: Динамическая адаптация**
  - [ ] Интегрировать Graph-RAG для анализа связей.
  - [ ] Адаптировать параметры на основе исторических данных.

- [ ] **Задача 8.3: Итеративные улучшения**
  - [ ] Собрать фидбек и обновить код.
  - [ ] Добавить новые инструменты/агенты по мере роста депозита.

- [ ] **Тестирование Этапа 8**
  - [ ] Мониторить систему в реальном времени (неделя тестов).
  - [ ] Анализировать метрики и корректировать.
  - [ ] Regression-тесты после изменений.

## Общие замечания
- **Последовательность**: Не переходите к следующему этапу без завершения предыдущего.
- **Инструменты**: Используйте Poetry для зависимостей, pytest для тестов, Black для форматирования.
- **Данные**: Используйте CSV или MT5-историю для тестов (бесплатно).
- **Риски**: Фокус на безопасности (валидация данных, обработка ошибок).
- **Цель**: Достичь реального тестирования как можно быстрее, с итеративными улучшениями.
